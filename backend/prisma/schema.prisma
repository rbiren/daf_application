// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

model Dealer {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  address   String?  // JSON string: { street, city, state, zip, country }
  phone     String?
  email     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users User[]
  units Unit[]

  @@map("dealers")
}

model User {
  id           String   @id @default(uuid())
  dealerId     String?  @map("dealer_id")
  email        String   @unique
  name         String
  role         String   // DEALER_TECH, DEALER_ADMIN, MFG_QA, MFG_ADMIN, SYSTEM_ADMIN
  passwordHash String   @map("password_hash")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  dealer            Dealer?            @relation(fields: [dealerId], references: [id])
  acceptanceRecords AcceptanceRecord[]
  unitEvents        UnitEvent[]
  auditLogs         AuditLog[]
  checklistTemplates ChecklistTemplate[] @relation("CreatedTemplates")

  // NEW: Manufacturer inspection relations
  inspectorRecords  ManufacturerInspectionRecord[] @relation("InspectorRecords")
  approvedRecords   ManufacturerInspectionRecord[] @relation("ApprovedRecords")
  itemNotes         ItemNote[]

  @@map("users")
}

model Model {
  id       String  @id @default(uuid())
  name     String
  code     String  @unique
  category String?
  active   Boolean @default(true)

  units Unit[]

  @@map("models")
}

model Option {
  id       String @id @default(uuid())
  name     String
  code     String @unique
  category String?

  unitOptions UnitOption[]

  @@map("options")
}

// ============================================================================
// UNIT MANAGEMENT
// ============================================================================

model Unit {
  id            String   @id @default(uuid())
  vin           String   @unique
  stockNumber   String?  @map("stock_number")
  dealerId      String?  @map("dealer_id")
  modelId       String?  @map("model_id")
  modelYear     Int      @map("model_year")
  exteriorColor String?  @map("exterior_color")
  interiorColor String?  @map("interior_color")
  chassisType   String?  @map("chassis_type")
  engineType    String?  @map("engine_type")
  gvwr          Int?     // Gross Vehicle Weight Rating
  shipDate      DateTime? @map("ship_date")
  receiveDate   DateTime? @map("receive_date")
  status        String   @default("PENDING_INSPECTION") // UnitStatus enum as string
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // NEW: Manufacturer approval workflow fields
  inspectionCompletedAt DateTime? @map("inspection_completed_at")
  approvedAt            DateTime? @map("approved_at")
  approvedById          String?   @map("approved_by_id")
  shippedAt             DateTime? @map("shipped_at")
  shippedById           String?   @map("shipped_by_id")

  // NEW: Unit profile information
  msrp                  Float?    // Manufacturer's Suggested Retail Price
  productionDate        DateTime? @map("production_date")
  plantLocation         String?   @map("plant_location")
  warrantyStartDate     DateTime? @map("warranty_start_date")
  specialInstructions   String?   @map("special_instructions") // JSON string for any special notes

  dealer                        Dealer?                        @relation(fields: [dealerId], references: [id])
  model                         Model?                         @relation(fields: [modelId], references: [id])
  unitOptions                   UnitOption[]
  pdiRecords                    PdiRecord[]
  acceptanceRecords             AcceptanceRecord[]
  unitEvents                    UnitEvent[]
  manufacturerInspectionRecords ManufacturerInspectionRecord[]

  @@index([vin])
  @@index([dealerId])
  @@index([status])
  @@map("units")
}

model UnitOption {
  id       String @id @default(uuid())
  unitId   String @map("unit_id")
  optionId String @map("option_id")

  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)
  option Option @relation(fields: [optionId], references: [id])

  @@unique([unitId, optionId])
  @@map("unit_options")
}

model UnitEvent {
  id          String   @id @default(uuid())
  unitId      String   @map("unit_id")
  eventType   String   @map("event_type") // EventType enum as string
  eventDate   DateTime @map("event_date")
  description String?
  source      String?
  userId      String?  @map("user_id")
  metadata    String?  // JSON string
  createdAt   DateTime @default(now()) @map("created_at")

  unit Unit  @relation(fields: [unitId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id])

  @@map("unit_events")
}

// ============================================================================
// PDI (Pre-Delivery Inspection)
// ============================================================================

model PdiRecord {
  id            String   @id @default(uuid())
  unitId        String   @map("unit_id")
  inspectorId   String?  @map("inspector_id")
  inspectorName String?  @map("inspector_name")
  completedAt   DateTime @map("completed_at")
  status        String   @default("COMPLETE") // PdiStatus enum as string
  totalItems    Int?     @map("total_items")
  passedItems   Int?     @map("passed_items")
  failedItems   Int?     @map("failed_items")
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")

  unit      Unit       @relation(fields: [unitId], references: [id], onDelete: Cascade)
  pdiItems  PdiItem[]
  pdiPhotos PdiPhoto[]

  @@map("pdi_records")
}

model PdiItem {
  id              String    @id @default(uuid())
  pdiId           String    @map("pdi_id")
  checklistItemId String?   @map("checklist_item_id")
  itemCode        String?   @map("item_code")
  itemDescription String?   @map("item_description")
  status          String    // ItemStatus enum as string
  notes           String?
  resolved        Boolean   @default(false)
  resolvedBy      String?   @map("resolved_by")
  resolvedAt      DateTime? @map("resolved_at")
  resolutionNotes String?   @map("resolution_notes")
  createdAt       DateTime  @default(now()) @map("created_at")

  pdiRecord PdiRecord  @relation(fields: [pdiId], references: [id], onDelete: Cascade)
  pdiPhotos PdiPhoto[]

  @@map("pdi_items")
}

model PdiPhoto {
  id            String    @id @default(uuid())
  pdiItemId     String?   @map("pdi_item_id")
  pdiId         String?   @map("pdi_id")
  filePath      String    @map("file_path")
  thumbnailPath String?   @map("thumbnail_path")
  photoType     String    @default("GENERAL") @map("photo_type") // PhotoType enum as string
  capturedAt    DateTime? @map("captured_at")
  metadata      String?   // JSON string
  createdAt     DateTime  @default(now()) @map("created_at")

  pdiItem   PdiItem?   @relation(fields: [pdiItemId], references: [id], onDelete: Cascade)
  pdiRecord PdiRecord? @relation(fields: [pdiId], references: [id], onDelete: Cascade)

  @@map("pdi_photos")
}

// ============================================================================
// ACCEPTANCE RECORDS
// ============================================================================

model AcceptanceRecord {
  id                 String    @id @default(uuid())
  unitId             String    @map("unit_id")
  userId             String    @map("user_id")
  startedAt          DateTime  @default(now()) @map("started_at")
  completedAt        DateTime? @map("completed_at")
  decision           String?   // AcceptanceDecision enum as string
  conditions         String?   // JSON string - Array of condition objects
  generalNotes       String?   @map("general_notes")
  signatureData      String?   @map("signature_data") // Base64 encoded signature
  signatureTimestamp DateTime? @map("signature_timestamp")
  signatureIp        String?   @map("signature_ip")
  deviceInfo         String?   @map("device_info") // JSON string
  locationData       String?   @map("location_data") // JSON string
  status             String    @default("IN_PROGRESS") // AcceptanceStatus enum as string
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  unit             Unit               @relation(fields: [unitId], references: [id], onDelete: Cascade)
  user             User               @relation(fields: [userId], references: [id])
  acceptanceItems  AcceptanceItem[]
  acceptancePhotos AcceptancePhoto[]

  @@index([unitId])
  @@index([status])
  @@map("acceptance_records")
}

model AcceptanceItem {
  id              String   @id @default(uuid())
  acceptanceId    String   @map("acceptance_id")
  checklistItemId String   @map("checklist_item_id")
  status          String   @default("PENDING") // ItemStatus enum as string
  notes           String?
  isIssue         Boolean  @default(false) @map("is_issue")
  issueSeverity   String?  @map("issue_severity") // IssueSeverity enum as string
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  acceptanceRecord AcceptanceRecord  @relation(fields: [acceptanceId], references: [id], onDelete: Cascade)
  checklistItem    ChecklistItem     @relation(fields: [checklistItemId], references: [id])
  acceptancePhotos AcceptancePhoto[]
  itemNotes        ItemNote[]

  @@index([acceptanceId])
  @@map("acceptance_items")
}

model AcceptancePhoto {
  id               String   @id @default(uuid())
  acceptanceItemId String?  @map("acceptance_item_id")
  acceptanceId     String?  @map("acceptance_id")
  filePath         String   @map("file_path")
  thumbnailPath    String?  @map("thumbnail_path")
  originalFilename String?  @map("original_filename")
  fileSize         Int?     @map("file_size")
  mimeType         String?  @map("mime_type")
  capturedAt       DateTime @map("captured_at")
  gpsLatitude      Float?   @map("gps_latitude")
  gpsLongitude     Float?   @map("gps_longitude")
  gpsAccuracy      Float?   @map("gps_accuracy")
  annotations      String?  // JSON string
  fileHash         String?  @map("file_hash")
  metadata         String?  // JSON string
  syncStatus       String   @default("SYNCED") @map("sync_status") // SyncStatus enum as string
  createdAt        DateTime @default(now()) @map("created_at")

  acceptanceItem   AcceptanceItem?   @relation(fields: [acceptanceItemId], references: [id], onDelete: Cascade)
  acceptanceRecord AcceptanceRecord? @relation(fields: [acceptanceId], references: [id], onDelete: Cascade)

  @@map("acceptance_photos")
}

// ============================================================================
// MANUFACTURER INSPECTION (Manufacturer's internal inspection before shipping)
// ============================================================================

model ManufacturerInspectionRecord {
  id                 String    @id @default(uuid())
  unitId             String    @map("unit_id")
  inspectorId        String    @map("inspector_id")
  startedAt          DateTime  @default(now()) @map("started_at")
  completedAt        DateTime? @map("completed_at")
  approvedAt         DateTime? @map("approved_at")
  approvedById       String?   @map("approved_by_id")
  status             String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, APPROVED, REJECTED
  totalItems         Int?      @map("total_items")
  passedItems        Int?      @map("passed_items")
  failedItems        Int?      @map("failed_items")
  issueItems         Int?      @map("issue_items")
  generalNotes       String?   @map("general_notes")
  signatureData      String?   @map("signature_data") // Base64 encoded signature
  signatureTimestamp DateTime? @map("signature_timestamp")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  unit                         Unit                          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  inspector                    User                          @relation("InspectorRecords", fields: [inspectorId], references: [id])
  approvedBy                   User?                         @relation("ApprovedRecords", fields: [approvedById], references: [id])
  manufacturerInspectionItems  ManufacturerInspectionItem[]
  manufacturerInspectionPhotos ManufacturerInspectionPhoto[]

  @@index([unitId])
  @@index([status])
  @@map("manufacturer_inspection_records")
}

model ManufacturerInspectionItem {
  id              String    @id @default(uuid())
  inspectionId    String    @map("inspection_id")
  checklistItemId String    @map("checklist_item_id")
  status          String    @default("PENDING") // PENDING, PASS, ISSUE, FAIL, NA
  notes           String?
  isIssue         Boolean   @default(false) @map("is_issue")
  issueSeverity   String?   @map("issue_severity") // MINOR, MODERATE, MAJOR, CRITICAL
  resolvedAt      DateTime? @map("resolved_at")
  resolutionNotes String?   @map("resolution_notes")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  inspectionRecord             ManufacturerInspectionRecord  @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  checklistItem                ChecklistItem                 @relation(fields: [checklistItemId], references: [id])
  manufacturerInspectionPhotos ManufacturerInspectionPhoto[]
  itemNotes                    ItemNote[]

  @@index([inspectionId])
  @@map("manufacturer_inspection_items")
}

model ManufacturerInspectionPhoto {
  id               String    @id @default(uuid())
  inspectionItemId String?   @map("inspection_item_id")
  inspectionId     String?   @map("inspection_id")
  filePath         String    @map("file_path")
  thumbnailPath    String?   @map("thumbnail_path")
  originalFilename String?   @map("original_filename")
  fileSize         Int?      @map("file_size")
  mimeType         String?   @map("mime_type")
  photoType        String    @default("GENERAL") @map("photo_type") // GENERAL, ISSUE, RESOLUTION, DOCUMENTATION
  capturedAt       DateTime  @map("captured_at")
  metadata         String?   // JSON string
  createdAt        DateTime  @default(now()) @map("created_at")

  inspectionItem   ManufacturerInspectionItem?   @relation(fields: [inspectionItemId], references: [id], onDelete: Cascade)
  inspectionRecord ManufacturerInspectionRecord? @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@map("manufacturer_inspection_photos")
}

// ============================================================================
// SHARED NOTES (Notes that can be shared between manufacturer and dealer)
// ============================================================================

model ItemNote {
  id                       String   @id @default(uuid())
  // Link to either manufacturer inspection item OR dealer acceptance item
  manufacturerItemId       String?  @map("manufacturer_item_id")
  acceptanceItemId         String?  @map("acceptance_item_id")
  authorId                 String   @map("author_id")
  authorRole               String   @map("author_role") // MANUFACTURER, DEALER
  content                  String
  visibleToDealer          Boolean  @default(false) @map("visible_to_dealer") // If false, only manufacturer can see
  visibleToManufacturer    Boolean  @default(true) @map("visible_to_manufacturer") // If false, only dealer can see
  submittedAt              DateTime? @map("submitted_at") // When note was officially submitted/shared
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  manufacturerItem ManufacturerInspectionItem? @relation(fields: [manufacturerItemId], references: [id], onDelete: Cascade)
  acceptanceItem   AcceptanceItem?             @relation(fields: [acceptanceItemId], references: [id], onDelete: Cascade)
  author           User                        @relation(fields: [authorId], references: [id])

  @@index([manufacturerItemId])
  @@index([acceptanceItemId])
  @@map("item_notes")
}

// ============================================================================
// CHECKLIST TEMPLATES
// ============================================================================

model ChecklistTemplate {
  id          String   @id @default(uuid())
  name        String
  version     Int      @default(1)
  description String?
  modelIds    String?  @map("model_ids") // JSON string of UUIDs of applicable models
  active      Boolean  @default(true)
  createdById String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // NEW: Template type to distinguish manufacturer vs dealer checklists
  templateType String  @default("DEALER") @map("template_type") // MANUFACTURER, DEALER

  createdBy  User?               @relation("CreatedTemplates", fields: [createdById], references: [id])
  categories ChecklistCategory[]

  @@map("checklist_templates")
}

model ChecklistCategory {
  id          String   @id @default(uuid())
  templateId  String   @map("template_id")
  name        String
  code        String?
  description String?
  orderNum    Int      @map("order_num")
  required    Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")

  template ChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  items    ChecklistItem[]

  @@map("checklist_categories")
}

model ChecklistItem {
  id                   String   @id @default(uuid())
  categoryId           String   @map("category_id")
  code                 String
  description          String
  instructions         String?
  orderNum             Int      @map("order_num")
  required             Boolean  @default(true)
  photoRequired        Boolean  @default(false) @map("photo_required")
  photoRequiredOnIssue Boolean  @default(true) @map("photo_required_on_issue")
  conditionLogic       String?  @map("condition_logic") // JSON string: { optionIds: [], logic: 'AND'|'OR'|'NOT' }
  createdAt            DateTime @default(now()) @map("created_at")

  // NEW: Standard requirements and documentation
  requirements         String?  // Standard requirement text that must be met
  standardDescription  String?  @map("standard_description") // Detailed standard description
  documentationUrl     String?  @map("documentation_url") // Link to reference documentation

  // NEW: Manufacturer/Dealer checklist mapping
  manufacturerOnly     Boolean  @default(false) @map("manufacturer_only") // If true, only shown in manufacturer checklist
  dealerVisible        Boolean  @default(true) @map("dealer_visible") // If false, hidden from dealer side-by-side
  mappedItemCode       String?  @map("mapped_item_code") // Code of corresponding item in other checklist for side-by-side matching

  category                    ChecklistCategory               @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  acceptanceItems             AcceptanceItem[]
  manufacturerInspectionItems ManufacturerInspectionItem[]

  @@map("checklist_items")
}

// ============================================================================
// AUDIT & SYNC
// ============================================================================

model AuditLog {
  id         String   @id @default(uuid())
  timestamp  DateTime @default(now())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValues  String?  @map("old_values") // JSON string
  newValues  String?  @map("new_values") // JSON string
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  requestId  String?  @map("request_id")

  user User? @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([timestamp])
  @@map("audit_logs")
}

model SyncQueue {
  id              String   @id @default(uuid())
  oduserId        String   @map("user_id")
  deviceId        String   @map("device_id")
  operationType   String   @map("operation_type")
  entityType      String   @map("entity_type")
  entityId        String?  @map("entity_id")
  payload         String   // JSON string
  clientTimestamp DateTime @map("client_timestamp")
  serverTimestamp DateTime @default(now()) @map("server_timestamp")
  status          String   @default("PENDING") // SyncStatus enum as string
  retryCount      Int      @default(0) @map("retry_count")
  errorMessage    String?  @map("error_message")
  processedAt     DateTime? @map("processed_at")

  @@index([status])
  @@index([oduserId, deviceId])
  @@map("sync_queue")
}
